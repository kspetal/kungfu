"use strict";const t=require("../../common/vendor.js"),e=require("../../store/index.js"),a={data:()=>({keyword:"",state:"",page:1,pageSize:20,students:[],listHeight:0,boyAvatar:"/static/boy.png",girlAvatar:"/static/girl.png",loading:!1,noMore:!1}),onLoad(){this.loadData()},onReady(){const e=t.index.getSystemInfoSync();this.listHeight=e.windowHeight-120},methods:{async loadData(a=!0){if(!this.loading){a?(this.page=1,this.noMore=!1):this.page++,this.loading=!0;try{const o=await t.tr.callFunction({name:"getStudentList",data:{page:this.page,state:this.state,pageSize:this.pageSize,keyword:this.keyword.trim()}});if(0!==o.result.code)return void t.index.showToast({title:o.result.msg||"加载失败",icon:"none"});const{list:s,total:r}=o.result.data,n=s.map((t=>({...t,progressValue:this.calcProgress(t),progressColor:this.calcProgressColor(t)})));this.students=a?n:[...this.students,...n];const{setStudents:i}=e.useGlobalStore();i(this.students),this.noMore=this.students.length>=r}catch(o){console.error("加载失败",o),t.index.showToast({title:"网络错误",icon:"none"})}finally{this.loading=!1,t.index.stopPullDownRefresh()}}},onPullDownRefresh(){this.loadData(!0)},onReachBottom(){this.noMore||this.loading||this.loadData(!1)},handleSearch(){this.loadData(!0)},handleFilterChange(t){this.state=t,this.loadData(!0)},formatDate:t=>t?t.split(" ")[0]:"",getStatusClass:t=>"在学"===t?"tag-status-ongoing":"已退学"===t?"tag-status-completed":"tag-status-ongoing",calcProgress(t){const e=t.current_total_course_date,a=t.current_total_course_date-t.current_use_date;if(!e)return 0;const o=e-a;return Math.round(Math.min(100,Math.max(0,o/e*100)))},calcProgressColor(t){const e=t.current_total_course_date,a=t.current_total_course_date-t.current_use_date;if(!e)return"#4CAF50";const o=a/e;return o<=.2?"#FF4D4F":o<=.5?"#1890FF":"#4CAF50"},goDetail(e){t.index.navigateTo({url:`/pages/student-detail/index?id=${e._id}`})},goCreate(){t.index.navigateTo({url:"/pages/student-form/index"})}}};const o=t._export_sfc(a,[["render",function(e,a,o,s,r,n){return t.e({a:t.o(((...t)=>n.handleSearch&&n.handleSearch(...t))),b:r.keyword,c:t.o((t=>r.keyword=t.detail.value)),d:t.o(((...t)=>n.handleSearch&&n.handleSearch(...t))),e:""===r.state?1:"",f:t.o((t=>n.handleFilterChange(""))),g:"在学"===r.state?1:"",h:t.o((t=>n.handleFilterChange("在学"))),i:"暂停"===r.state?1:"",j:t.o((t=>n.handleFilterChange("暂停"))),k:"已休学"===r.state?1:"",l:t.o((t=>n.handleFilterChange("已休学"))),m:0===r.students.length},(r.students.length,{}),{n:t.f(r.students,((e,a,o)=>({a:e.avatar_url||("女"==e.gender?r.girlAvatar:r.boyAvatar),b:t.t(e.name),c:t.t(e.current_project||"-"),d:t.t(e.status||"在学"),e:t.n(n.getStatusClass(e.status)),f:t.t(e.total_fee||0),g:t.t(e.end_time||"-"),h:t.t(e.progressValue),i:t.t(e.current_total_course_date-e.current_use_date||0),j:t.t(e.current_total_course_date||0),k:e.progressValue+"%",l:e.progressColor,m:e._id,n:t.o((t=>n.goDetail(e)),e._id)}))),o:r.listHeight+"px",p:t.o(((...t)=>n.onReachBottom&&n.onReachBottom(...t))),q:t.o(((...t)=>n.onPullDownRefresh&&n.onPullDownRefresh(...t))),r:t.o(((...t)=>n.goCreate&&n.goCreate(...t)))})}],["__scopeId","data-v-2d6c364c"]]);wx.createPage(o);
